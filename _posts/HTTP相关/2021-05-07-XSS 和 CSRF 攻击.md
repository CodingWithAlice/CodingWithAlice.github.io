---
layout:     post
title:     XSS 和 CSRF 攻击
subtitle:  
date:       2021-05-07
author:     
header-img: 
catalog: true
tags:
    - < HTTP相关 >
typora-root-url: ..
---


# XSS 和 CSRF 攻击

- 总结

  1、页面安全问题的主要原因就是浏览器为同源策略开的两个“后门”：

  ​	页面中可以任意引用第三方资源

  ​	通过 CORS 策略让 XMLHttpRequest 和 Fetch 去跨域请求资源

​	2、为了解决这些问题：

​		引入了 CSP 来限制页面任意引入外部资源

​		引入了 HttpOnly 机制来禁止 XMLHttpRequest 或者 Fetch 发送一些关键 Cookie

​		引入了 SameSite 和 Origin 来防止 CSRF 攻击

## XSS攻击

- 总结

  1、XSS 攻击就是黑客往页面中注入恶意脚本，然后将页面的一些重要数据上传到恶意服务器

  2、常见的三种 XSS 攻击模式是存储型 XSS 攻击、反射型 XSS 攻击和基于 DOM 的 XSS 攻击

  ​	三种攻击方式的**共同点**是都需要往用户的页面中注入恶意脚本，然后再通过恶意脚本将用户数据上传到黑客的恶意服务器上

  ​	三者的**不同点**在于注入的方式不一样，有通过服务器漏洞来进行注入的，还有在客户端直接注入的

  3、针对这些 XSS 攻击，主要有三种防范策略

  ​	第一种是通过服务器对输入的内容进行过滤或者转码

  ​	第二种是充分利用好 CSP

  ​	第三种是使用 HttpOnly 来保护重要的 Cookie 信息



XSS攻击 Cross Site Script ：即**跨域脚本攻击**（为和CSS区分，改叫XSS）

定义：是一种代码注入攻击， 攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行；

分类：反射型（非持久型）、存储型（持久型）、基于DOM

### 1、反射型 — 恶意链接

【简单描述】

​	将用户输入的存在XSS攻击的数据，发送给后台，后台并未对数据进行存储，也未经过任何过滤，直接返回给客户端，被浏览器渲染

【具体步骤】

1、构造出包含恶意代码的url，url指向目标网站，参数拼接恶意代码，举例如下：

<img src="/../img/assets_2019/image-20210507105832153.png" alt="image-20210507105832153" style="zoom:40%;" />

2、诱导用户点击，点击后会向服务端发送请求，同时查询参数携带恶意代码

3、服务端返回时**将恶意代码直接拼接在HTML**

4、客户端接收并解析执行代码时，恶意代码也被执行

【特点】

​	需要攻击者诱使用户操作：点击一个恶意链接/提交一个表单/进入一个恶意网站

【常见场景】

​	通过 URL 传递参数的场景，如网站搜索、跳转

### 2、存储型

【简单描述】

​	数据库中存有存在XSS攻击的数据，返回给客户端，数据未经任何转义被浏览器渲染

【具体步骤】

1. 把恶意代码提交到服务器端，
2. 当浏览器向服务器请求数据时，**恶意代码拼接在HTML中**从服务器传回
3. 客户端解析时被执行恶意代码，将用户Cookie信息等数据上传到恶意服务器

【特点】

这种 XSS 攻击具有很强的稳定性

【常见场景】

​	论坛发帖、商品评论、用户私信等，攻击者发布包含恶意 JS 代码的评论，所有访问的用户的浏览器中会被执行这段恶意的 JS 代码

<img src="/../img/assets_2019/image-20210507110126121.png" alt="image-20210507110126121" style="zoom:40%;" />

### 3、基于 DOM 的 XSS 攻击

【特点】

通过恶意脚本修改页面的 DOM 结构，是纯粹发生在客户端的攻击。

【可能性】

1、`<script>`标签

2、a标签的href、img 上src，例如：`<img src="javascript:alert('XSS')” />`

3、`innerHTML/outerHTML=xx` 或 `setTimeout/setInterval` (执行js)

4、`document.write` 或 eval

5、`location`、`onclick`、`onerror`、`onload`、`onmouseover`等事件（执行js），例如：`<img src="#" onerror=“alert('1')" />`

6、在 style 属性中，包含类似 `background-image:url(“javascript:alert('XSS')”);`的代码（新版本浏览器已经可以防范）

7、在 style 属性和标签中，包含类似 `expression(…)` 的 CSS 表达式代码(新版本浏览器已经可以防范)

### XSS 攻击解决方案

无论是何种类型的 XSS 攻击，它们都有一个**共同点**，那就是首先往浏览器中注入恶意脚本，然后再通过恶意脚本将用户信息发送至黑客部署的恶意服务器上

我们可以通过【阻止恶意 JavaScript 脚本的注入】和【恶意消息的发送】来实现

|                     **XSS 攻击解决方案**                     | **详细说明**                                                 | **解决问题**                                                 |
| :----------------------------------------------------------: | ------------------------------------------------------------ | ------------------------------------------------------------ |
|                    防范反射型、存储型 XSS                    | 1、采用纯前端渲染 2、拼接 HTML 时，要对 HTML 进行充分转义（过滤<script>标签，或者转码<script> —> &lt;script&gt;） | 即使这段脚本返回给页面，页面也不会执行这段脚本               |
|                       防范 DOM 型 XSS                        | 1、将用户输入插入 HTML 或拼接 js 执行时，要进行编码，将一些特殊字符转义 2、对于 a 标签的 href 等外链请求，添加白名单进行过滤，禁止以 javascript: 开头的链接，和其他非法的 scheme |                                                              |
|                       内容安全策略 CSP                       | 内置于浏览器，只信任白名单网站 详解见下方                    | 核心思想是让服务器决定浏览器能够加载哪些资源，让服务器决定浏览器是否能够执行内联 JavaScript 代码，大大减少XSS攻击 |
| HttpOnly标准 （防止劫取 Cookie） （HttpOnly是服务器通过 HTTP 响应头来设置的） | 浏览器禁止页面的JS 访问带有 HttpOnly 属性的Cookie <img src="/../img/assets_2019/image-20210507111719291.png" alt="image-20210507111719291" style="zoom:40%;" /> | 攻击者通过注入恶意脚本获取用户的Cookie信息，发起Cookie劫持攻击；HttpOnly **【阻止 XSS 攻击后的 Cookie 劫持攻击】**； |
|                用户的输入检查 （XSS Filter）                 | 不要相信用户的任何输入，要进行检查、过滤和转义；             | 检查用户输入中是否包含 <，> 等特殊字符，如果存在，则对特殊字符进行过滤或编码 |
|                        服务端输出检查                        | 除富文本的输出外，在变量输出到 HTML 页面时，可以使用编码或转义的方式来防御 XSS 攻击 |                                                              |