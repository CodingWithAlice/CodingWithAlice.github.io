---
layout:     post
title:     跨页面通信
subtitle:  
date:       2021-06-29
author:     
header-img: 
catalog: true
tags:
    - < 面试题整理 >
typora-root-url: ..
---



# 跨页面通信（7种）

参考文章：[跨页面通信](https://juejin.cn/post/6844903811232825357)

两个页面之间的通信会涉及到<span style="color: red">同源策略</span>的限制，所以按照是否满足同源策略的限制分成两大部分来看。

## 同源页面间的通信

1-3 三种类型都是有一个“中央站”的概念，由中央站再通知给各个页面

### 1/6、广播式通信 BroadCast Channel

主要参考文章：

- [前端广播式通信：Broadcast Channel](https://juejin.cn/post/6844903811228663815)

核心要点：

- 所有页面都监听同一频道的消息，其中某一个页面通过它发送的消息就会被其他所有页面收到

<span style="color: red">注意：两个页面都需要对同一个频道实例化</span>

```js
// 页面1
const ling = new BroadcastChannel('junZhe');//实例化
/* 发送消息 */
ling.postMessage('是真的！');
```

```js
// 页面2
const ling = new BroadcastChannel('junZhe');//实例化
/* 监听被广播的消息 - 也可以使用 addEventListener 来监听 message */
ling.onmessage = function (e) {
    const data = e.data;// 是真的！
};
```

### 2/6、消息中转站 Service Worker

主要参考文章：

- [Service Worker](https://juejin.cn/post/6844903588691443725)、尤雨溪大大点赞的文章：[PWA实战](https://zhuanlan.zhihu.com/p/25800461)

核心要点：

- Service Worker只能运行在 `HTTPS` 、`localhost（127.0.0.1）` 域下
- Service Worker的各类操作都被设计为**异步 Promise**，用以避免一些长时间的阻塞操作

【没有进行实践】

### 3/6、LocalStorage

核心要点：

- 当 `LocalStorage` 属性的值变化时，会触发 `storage` 事件

```js
// 监听 localstroage 的变化
window.addEventListener('storage', function (e) {
    if (e.key === 'junzhe') {
        const data = JSON.parse(e.newValue); 
        // {message: '是真的', ts: 1625054508019}
    }
});
```

```js
// 改变 LocalStorage -> 加 ts 是因为 storage 事件只在 值 真正改变时触发
let ts = +new Date();
let data = {
    message: '是真的',
    ts,
};
localStorage.setItem('junzhe', JSON.stringify(data));
```

### 4/6、Shared Worker

核心要点：

- 多个 Tab 注册的 Shared Worker 可以实现数据共享
- 无法主动通知所有页面，使用<span style="color:red">轮询</span>的方式拉取最新的数据

【没有进行实践】

#### 5/6、IndexedDB

核心要点：

- 消息发送方将消息存至 `IndexedDB` 中，接收方通过<span style="color:red">轮询</span>去获取最新的信息

#### 6/6、通过 window.open 实现

核心要点：

- 通过 A 页面打开 B 页面，可以形成页面树状结构

缺点：如果 B 页面不是从 A 页面打开的，就失去了结构



## 非同源页面间的通信

#### 通过 iframe 转换成同源页面通信

核心要点：

- 由于 `iframe` 与父页面间可以通过指定 `origin` 来忽略同源限制，因此可以在每个页面中嵌入同一个 `iframe` —> 这些 iframe 由于使用的是一个 url，因此属于同源页面，其通信方式可以复用上面第一部分提到的各种方式

