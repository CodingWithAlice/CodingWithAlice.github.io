---
layout:     post
title:     04 导航流程：从输入url到打开页面发生了什么
subtitle:  
date:       2021-04-08
author:     
header-img: 
catalog: true
tags:
    - < 浏览器原理 >
typora-root-url: ..
---


# 04 导航流程：从输入url到打开页面发生了什么

导航流程：用户发出URL请求到页面开始解析的这个过程

从输入URL到页面展示流程：
![image-20210408215608834](/../img/assets_2019/image-20210408215608834.png)

## 1、用户输入
-   查询关键字是url -- 根据规则，把这段内容加上协议，合成为完整的URL
-   查询关键字是搜索内容 -- 使用浏览器默认的搜索引擎，来合成新的带搜索关键字的URL
 ## 2、URL请求过程
**浏览器进程**会通过进程间通信（IPC）把URL请求发送至**网络进程**，网络进程接收到URL请求后，会在这里发起真正的URL请求流程。

URL请求流程
1、网络进程会查找**本地缓存**是否缓存了该资源
-   有，直接返回资源
-   没有缓存，进入网络请求流程

2、第一步是要进行**DNS解析**，获取 ip 地址
- 如果请求协议是HTTPS，那么还需要建立TLS连接

3、利用IP地址和服务器建立**TCP连接**

4、浏览器端会构建请求行、请求头等信息，并把和该域名相关的Cookie等数据附加到请求头中，然后**向服务器发送构建的请求信息**

5、服务器会根据请求信息**生成响应数据**，并发给**网络进程**

7、**网络进程解析响应头**
-   返回的状态码是301或者302 -- 重定向，网络进程会从响应头的Location字段里面读取重定向的地址，然后再发起新的HTTP或者HTTPS请求，一切又重头开始了
-   状态码是200，继续解析

8、响应数据类型处理，区分响应体中的数据类型
- 响应头中`Content-Type:text/html`为HTML格式，继续进行导航流程，**准备渲染进程**

- 如果响应头中`Content-Type:application/octet-stream`为字节流类型的，通常情况下，浏览器会按照下载类型来处理该请求 -- 该请求会被提交给浏览器的下载管理器，同时该URL请求的**导航流程就此结束**

  ![image-20210408220356655](/../img/assets_2019/image-20210408220356655.png)
## 3、准备渲染进程
渲染进程策略：
-   默认情况下，Chrome会为**每个页面分配一个渲染进程**
-   新页面和当前页面属于同一站点，那么新页面会复用父页面的渲染进程 --> **多个页面直接运行在同一个渲染进程**中【process-per-site-instance策略】

注意：同一站点（same-site）：根域名（例如，geekbang.org）加上协议（例如，https:// 或者http://），还包含了该根域名下的所有子域名和不同的端口，如下所示：
```javascript
https://time.geekbang.org
https://www.geekbang.org
https://www.geekbang.org:8080
```

注意：渲染进程准备好之后，还不能立即进入文档解析状态，因为此时的文档数据还在**网络进程**中，并没有提交给渲染进程，所以下一步就进入了提交文档阶段。

## 4、提交文档
文档：指URL请求的响应体数据
准备好渲染进程之后，在三个进程之间有个“提交文档”的消息在处理，处理流程如下：
![image-20210408220519097](/../img/assets_2019/image-20210408220519097.png)

1⃣️：“提交文档”的消息是由**浏览器进程**发出的
2⃣️：**渲染进程**接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”
3⃣️：等文档数据传输完成之后，**渲染进程**会返回“确认提交”的消息给浏览器进程
4⃣️：**浏览器进程**在收到“确认提交”的消息后，会更新浏览器界面状态，包括了**安全状态、地址栏的URL、前进后退的历史状态，并更新Web页面**，即下图标注的四个内容
![image-20210408221028061](/../img/assets_2019/image-20210408221028061.png)

所以：在浏览器的地址栏里面输入了一个地址后，之前的页面没有立马消失，而是要加载一会儿才会更新页面

## 5、渲染阶段
在这个阶段进行页面解析和子资源加载，完成后**渲染进程**会发送一个消息给**浏览器进程**，浏览器接收到消息后，会停止标签图标上的加载动画
![image-20210408221050867](/../img/assets_2019/image-20210408221050867.png)

